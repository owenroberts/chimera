<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>chimera</title>
	<script src="lib/three.min.js"></script>
	<script src="lib/ar.js"></script>
	<script>THREEx.ArToolkitContext.baseURL = './lib/'</script>
	<style>
		canvas {
			position: absolute;
			top: 0px;
			left: 0px;
		}
	</style>
</head>

<body style='margin : 0px; overflow: hidden;'>
	<script>

		// const w = window.innerWidth, h = window.innerHeight;
		const w = 640, h = 480;
		
		const renderer = new THREE.WebGLRenderer({
			antialias: true,
			alpha: true
		});
		renderer.setClearColor(new THREE.Color('lightgrey'), 0)
		renderer.setSize( w, h );
		document.body.appendChild( renderer.domElement );

		const scene = new THREE.Scene();
		const camera = new THREE.Camera();
		scene.add(camera);

		const arToolkitSource = new THREEx.ArToolkitSource({
			sourceType : 'webcam',
			sourceUrl: null,
			sourceWidth: w,
			sourceHeight: h,
			displayWidth: w,
			displayHeight: h
		});

		arToolkitSource.init(function onReady(){
			setTimeout(() => {
				onResize()
			}, 2000);
		});

		function onResize(){
			arToolkitSource.onResizeElement();
			arToolkitSource.copyElementSizeTo(renderer.domElement);
			if (arToolkitContext.arController !== null ){
				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
			}
		}

		const arToolkitContext = new THREEx.ArToolkitContext({
			debug: false,
			detectionMode: 'color_and_matrix',
			matrixCodeType: '3x3',
			patternRatio: 0.5,
			maxDetectionRate: 60,
			canvasWidth: w,
    		canvasHeight: h,
    		imageSmoothingEnabled : true,
		});

		arToolkitContext.init(function onCompleted(){
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		});

		const markerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
			size: 1,
			type: "unknown",
			patternUrl: null,
			barcodeValue: null,
			changeMatrixMode: "modelViewMatrix",
			smooth: true,
			smoothCount: 5,
			smoothTolerance: 0.01,
			smoothThreshold: 2
		});
		scene.visible = false

		var geometry = new THREE.CubeGeometry(1,1,1);
		var material = new THREE.MeshNormalMaterial({
			transparent : true,
			opacity: 0.5,
			side: THREE.DoubleSide
		});
		var mesh = new THREE.Mesh( geometry, material );
		mesh.position.y	= geometry.parameters.height/2;
		scene.add( mesh );

		var geometry = new THREE.TorusKnotGeometry(0.3,0.1,64,16);
		var material = new THREE.MeshNormalMaterial();
		var mesh = new THREE.Mesh( geometry, material );
		mesh.position.y	= 0.5
		scene.add( mesh );


		let lastTime = null;
		function render(time) {
			requestAnimationFrame(render);
			lastTime = lastTime || time - 1000/60;
			const delta	= Math.min(200, time - lastTime);
			lastTime = time;
			
			if (arToolkitSource.ready === false) return;
			arToolkitContext.update(arToolkitSource.domElement);
			scene.visible = camera.visible;
			// mesh.rotation.x += Math.PI * delta;
			renderer.render( scene, camera );
		}

		requestAnimationFrame(render);

	</script>
</body>
</html>